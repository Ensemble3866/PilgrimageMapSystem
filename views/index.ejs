<!DOCTYPE html>
<html lang="en" style="height: 100%;">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="google-signin-client_id" content="814313851398-vsb7c2m68g7l6h71352h9fs5hqs39fe7.apps.googleusercontent.com"></meta>
		<title>聖地足跡/來一趟專屬於你的動漫聖地巡禮吧！</title>
		<!-- Bootstrap -->
		<link href="stylesheets/bootstrap.min.css" rel="stylesheet">
		<style>
			body {
				padding-top: 50px;
			}
			p { 
				line-height: 1.7em;
				margin-after: 0.5em;
				text-align: justify; 
				text-justify: inter-ideographic;
				word-break: break-all;
			}
			.center-block {
				display: block;
				margin-left: auto;
				margin-right: auto;
			}
			.show {
				display: block !important;
			}
			.hidden {
				display: none !important;
				visibility: hidden !important;
			}
			.invisible {
				visibility: hidden;
			}

		</style>
		<!-- jQuery (Bootstrap 所有外掛均需要使用) -->
		<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" ></script>
		<!-- jQuery tmpl 模板功能 -->
		<script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
		<!-- 依需要參考已編譯外掛版本（如下），或各自獨立的外掛版本 -->
		<script src="javascripts/bootstrap.min.js"></script>
		<!--work模板-->
		<script  type="text/x-jquery-tmpl" id="tmpl_work">
			<!--其中一個作品-->
			<div class="row" id="work">
				<!--文字資訊-->
				<div class="col-md-5" id="text">
					<h3>${name}</h3>
					<p>${category}</p>
					<p>${intro}</p>
				</div>
				<!--圖片資訊-->
				<div class='col-md-6 col-md-offset-1' id='work${workId}_pics' style='border:1px solid #F05E1C;  border-radius:20px;'>
					<br/>
				</div>
			</div>
			<hr/>
		</script>
		<!--work中的pic模板-->
		<script  type="text/x-jquery-tmpl" id="tmpl_work_pic">
			<div class='row'>
				<div class='col-md-6' id='pic_orgin'>
					<img src=${workImgUrl} alt='test_pic_anime' class='img-responsive img-thumbnail' title='${sceneName} (動場場景)' />
				</div>
				<div class='col-md-6' id='pic_comparison'>
					<img src=${realImgUrl} alt='test_pic_real' class='img-responsive img-thumbnail' title='${sceneName} (現實場景)' />
				</div>
			</div>
		</script>
		<!-- HTML5 shim and Respond.js 讓 IE8 支援 HTML5 元素與媒體查詢 -->
		<!-- 警告：Respond.js 無法在 file:// 協定下運作 -->
		<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
	</head>
	<body style="height: 100%;">
	<script type="text/javascript">
		// Set varibles will be used
		var map;
		var markers = [];
		var auth2 = {};

		// Set Google Map Function
		function initMap() {
			map = new google.maps.Map(document.getElementById('map'), {
				//mapOptions
				zoom: 6,
				center: {lat: 36.2048240, lng: 138.2529240},
				mapTypeControl: true,	
				mapTypeControlOptions: {
					position: google.maps.ControlPosition.LEFT_BOTTOM
				}
			});
			<% for(var index in placemark) {%>
				var marker = new google.maps.Marker({
					position : new google.maps.LatLng(<%= placemark[index].latitude %>,<%= placemark[index].longitude %>),
					map : map,
					//icon : 'static/pic/placemark.png',
					label : {
						text :'<% for(var i in placemark[index].work) {%><%=placemark[index].work[i].c_name %><%=placemark[index].work[i].j_name %> <% } %>', 
						fontSize :'0px'
					},
					title : '<%= placemark[index].name %>'
				});
				marker.addListener('click', function(){
					//show placemark infomation
					$.get("/placemark/"+"<%= placemark[index]._id %>", function(data, status){
						if(status=="success"){
							var sceneCount=0;
							
							//座標資訊	
							$("#place").html(
								"<h2>"+data.placemark.name+" <small><span class='label label-info'>"+data.placemark.work.length+" 個作品</span></small></h2>"+
								"<p>"+data.placemark.description+"</p>"
							);
							//清空區塊
							$("#works").empty();
							//填上找到的所有作品資料
							for(var i in data.placemark.work) {
								//文字部分
								var work=[{
								name:data.placemark.work[i].c_name+" / "+data.placemark.work[i].j_name,
								category:data.placemark.work[i].category,
								intro:data.placemark.work[i].introduction,
								workId:i,
								}];
								$( "#tmpl_work" ).tmpl( work ) .appendTo( "#works" ); 
								//圖片部分
								while(data.scenes[sceneCount].work==data.placemark.work[i]._id) {
									var pic=[{
									workImgUrl:"imgs/"+data.scenes[sceneCount].workImgUrl,
									realImgUrl:"imgs/"+data.scenes[sceneCount].realImgUrl,
									sceneName:data.scenes[sceneCount].name
									}];
									$( "#tmpl_work_pic" ).tmpl( pic ) .appendTo( "#work"+i+"_pics" ); 
									sceneCount++;
									if(data.scenes[sceneCount].work==data.placemark.work[i]._id) $("#work"+i+"_pics").append("<hr/ style='border-color:#A35E47;'>");
									else $("#work"+i+"_pics").append("<br/>");
									if(sceneCount>=data.scenes.length) break;
								};
							}
							//上區施工中
						}
					});
				});
				markers.push(marker);
			<% } %>
			google.maps.event.addDomListener(window, "load", initMap);
		};
		
		//Facebook SDK init
		window.fbAsyncInit = function() {
			FB.init({
				appId      : '316465528767796',
				cookie     : true,  // enable cookies to allow the server to access the session
				xfbml      : true,  // parse social plugins on this page
				version    : 'v2.8' // use graph api version 2.8
			});
		};

		// Load the SDK asynchronously
		(function(d, s, id) {
			var js, fjs = d.getElementsByTagName(s)[0];
			if (d.getElementById(id)) return;
			js = d.createElement(s); js.id = id;
			js.src = "//connect.facebook.net/zh_TW/sdk.js";
			fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));
		
		// Begin Google+ API Function
		var googleAuth = (function() { return {
			onSignInCallback: function(authResult) {
				if (authResult.isSignedIn.get()) {
					gapi.client.plus.people.get({
						'userId': 'me'
					}).then(function(res) {
						var profile = res.result;
						$.post("/userAuth", {
							userId : profile.id,
							userName : profile.displayName,
							website : 2
						}, function(data, status){
							if(status == "success") {
								$("li").addClass("hidden");
								switch(data.code){
									case 0:
										$("#btnManagePage").removeClass("hidden");
										$("#btnUploadScene").removeClass("hidden");
										$("#btnTargetScene").removeClass("hidden");
										$("#btnManageAuth").removeClass("hidden");
										break;
									case 1:
										$("#btnManagePage").removeClass("hidden");
										$("#btnUploadScene").removeClass("hidden");
										$("#btnTargetScene").removeClass("hidden");
										break;
									case 2:
										$("#btnUploadScene").removeClass("hidden");
										$("#btnTargetScene").removeClass("hidden");
										break;
									default:
										break;
								}
								$("#gDisconnect").removeClass("hidden");
							}
						});
						console.log(profile);
					}, function(err) {
						console.log(err.result.message);
					});
				} else {
					if (authResult['error'] || authResult.currentUser.get().getAuthResponse() == null) {
						// There was an error, which means the user is not signed in.
						// As an example, you can handle by writing to the console:
						console.log('There was an error: ' + authResult['error']);
					}
					$("li").addClass("hidden");
					$("#gConnect").removeClass("hidden");
					$("#signin-button").removeClass("hidden");
				}
			},

			//Calls the OAuth2 endpoint to disconnect the app for the user.
			disconnect: function() {
				// Revoke the access token.
				auth2.disconnect();
			},
			
			// Gets and renders the currently signed in user's profile data.
		};})();

		// Handler for when the sign-in state changes.
		var updateSignIn = function() {
			if (auth2.isSignedIn.get()) {
				console.log('signed in');
				googleAuth.onSignInCallback(gapi.auth2.getAuthInstance());
			}else{
				console.log('signed out');
				googleAuth.onSignInCallback(gapi.auth2.getAuthInstance());
			}
		}

		// This method sets up the sign-in listener after the client library loads.
		function startApp() {
			gapi.load('auth2', function() {
				gapi.client.load('plus','v1').then(function() {
				gapi.signin2.render('signin-button', {
					scope: 'https://www.googleapis.com/auth/plus.login',
					height: 27,
					fetch_basic_profile: false });
				gapi.auth2.init({fetch_basic_profile: false,
					scope:'https://www.googleapis.com/auth/plus.login'}).then(
						function (){
						auth2 = gapi.auth2.getAuthInstance();
						auth2.isSignedIn.listen(updateSignIn);
						auth2.then(updateSignIn);
					});
				});
			});
		}
		// END Google+ API Function

		// Begin JQuery control Function
		$(document).ready(function() {
			$("#btnGdisconnect").click(googleAuth.disconnect);
			$("#btnFilterWork").click(function(){
				for (var i = 0; i < markers.length; i++) {
					if(markers[i].getLabel().text.match($("#keyword").val()) == null){
						markers[i].setMap(null);
					}
					else{
						markers[i].setMap(map);
					} 
				}
			});
			$("#keyword").keydown(function(event){
				if( event.which == 13 ) {
					$("#btnFilterWork").trigger("click");
				}
			});
		});

		$(window).load(function(){
			initMap();
		});
		// End JQuery control Function

	</script>
	<script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALm13waMtWSh3upgvjnblpwSPBPLI3oe0">
    </script>
	<script src="https://apis.google.com/js/client:platform.js?onload=startApp"></script>
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand" href="#">
					<span class="glyphicon glyphicon-home"></span>
				</a>
				<!--
				<a class="navbar-brand" href="#">Logo
					<img alt="Logo" src="#"> 
				</a>
				-->
				<from class="navbar-form navbar-left form-inline" role="form" action="/" method="post" id="search">
					<div class="form-group">
						<div class="input-group">
							<input type="text" class="form-control" id="keyword" style="width: 500px;">
				   			<span class="input-group-btn">
				   				<button type="submit" class="btn btn-default btn-md" id="btnFilterWork">找作品
				   					<span class="glyphicon glyphicon-search" aria-hidden="true"></span>
								</button>
				   			</span>
			   			</div>
		   			</div>
	  			</from>
			</div>
			<ul class="nav navbar-nav navbar-right" id="user_bar">
				<li id="btnShowNews" class="hidden"><a href="#"><span class="glyphicon glyphicon-bullhorn"></span> 最新消息</a></li>
				<li id="btnTargetScene" class="hidden"><a href="#"><span class="glyphicon glyphicon-map-marker"></span> 目標景點</a></li>
				<li id="btnUploadScene" class="hidden"><a href="#"><span class="glyphicon glyphicon-cloud-upload"></span> 新增景點</a></li>
				<li id="btnManagePage" class="hidden"><a href="/manage"><span class="glyphicon glyphicon-cog"></span> 管理頁面</a></li>
				<li id="btnManageAuth" class="hidden"><a href="/setauth"><span class="glyphicon glyphicon-user"></span> 管理權限</a></li>
				<li id="gConnect" class="hidden" style="padding-top: 10px; padding-left: 10px; padding-right: 15px;">
					<div id="signin-button" class="hidden"></div>
				</li>
				<li id="gDisconnect" class="hidden" style="padding-top: 10px; padding-left: 10px; padding-right: 20px;">
					<button class="btn btn-default btn-sm" id="btnGdisconnect" >登出</button>
				</li>
			</ul>
		</div>
	</nav>
    <div id="map" style="height: 80%; width: 100%;"></div>
    <br>
    <!--Introduction-->
	<div class="container" id="intro">	
		<!--顯示地點資訊-->
		<div class="page-header" id="place">
			<h2>Where</h2>
		</div><br/>

		<!--顯示所在地點的所有作品-->
		<div class="container" id="works">
			<!--其中一個作品-->
			<div class="row" id="work">
				<!--文字資訊-->
				<div class="col-md-5" id="text">
					<h3>測試 / テスト</h3>
					<p>類型</p>
					<p>介紹內容..........</p>
				</div>
				<!--圖片資訊-->
				<div class="col-md-6 col-md-offset-1" id="pics" style="border:1px solid #F05E1C;  border-radius:20px;">
					<div class="row">
						<div class="col-md-6" id="pic_orgin">
							<img src="http://i.imgur.com/bqs2qym.jpg" alt="test_pic" class="img-responsive img-round" />
						</div>
						<div class="col-md-6" id="pic_comparison">
							<img src="http://i.imgur.com/bqs2qym.jpg" alt="test_pic" class="img-responsive img-circle" />
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>
	<!--施工中-->
	</body>
</html>